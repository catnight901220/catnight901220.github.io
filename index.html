<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width">
  <title>å¤šç›Šè€ƒè©¦ç·´ç¿’ç³»çµ± - å¢å¼·é«”é©—</title>

  <style>
    :root {
      --primary-color: #2196f3;
      --secondary-color: #4caf50;
      --error-color: #f44336;
      --success-color: #4caf50;
      --text-color: #333;
      --bg-color: #f5f5f5;
      --card-bg: #ffffff;

      /* æ–°å¢æ¼¸å±¤èƒŒæ™¯è‰²ï¼Œå¯ä¾å–œå¥½èª¿æ•´ */
      --header-gradient: linear-gradient(135deg, #2196f3, #1976d2);
    }

    body {
      font-family: 'Microsoft JhengHei', sans-serif;
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
      background-color: var(--bg-color);
      color: var(--text-color);
      line-height: 1.6;
      transition: all 0.3s ease;  /* åœ¨åˆ‡æ›æ¨¡å¼æ™‚åšå¹³æ»‘è½‰æ› */
    }

    .container {
      background-color: var(--card-bg);
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      position: relative;
      overflow: hidden;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px;
      background: var(--header-gradient);
      color: white;
      border-radius: 10px;
      animation: fadeIn 0.8s ease;
    }

    h1 {
      margin: 0;
      font-size: 2.5em;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }

    .progress-bar {
      width: 100%;
      height: 20px;
      background-color: #e0e0e0;
      border-radius: 10px;
      margin: 10px 0;
      overflow: hidden;
    }

    .progress {
      height: 100%;
      background-color: var(--secondary-color);
      transition: width 0.3s ease;
    }

    .stats {
      display: flex;
      justify-content: space-around;
      margin: 20px 0;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 10px;
      animation: fadeIn 0.6s ease;
    }

    .stat-item {
      text-align: center;
    }

    .stat-value {
      font-size: 1.5em;
      font-weight: bold;
      color: var(--primary-color);
    }

    .section {
      margin: 30px 0;
      padding: 20px;
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      background-color: white;
      animation: fadeIn 0.6s ease;
    }

    .question {
      margin: 20px 0;
      padding: 20px;
      background-color: #f8f9fa;
      border-radius: 10px;
      border-left: 4px solid var(--primary-color);
      opacity: 0;
      animation: fadeInQuestion 0.8s forwards;
    }

    @keyframes fadeInQuestion {
      0% { opacity: 0; transform: translateY(10px); }
      100% { opacity: 1; transform: translateY(0); }
    }

    .option {
      margin: 10px 0;
      padding: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      opacity: 0;
      animation: fadeInOption 0.8s forwards;
    }

    /* è®“é¸é …åˆ†æ‰¹å‡ºç¾ */
    .option:nth-child(2) {
      animation-delay: 0.1s;
    }
    .option:nth-child(3) {
      animation-delay: 0.2s;
    }
    .option:nth-child(4) {
      animation-delay: 0.3s;
    }
    .option:nth-child(5) {
      animation-delay: 0.4s;
    }

    @keyframes fadeInOption {
      0% { opacity: 0; transform: translateY(5px); }
      100% { opacity: 1; transform: translateY(0); }
    }

    .option:hover {
      background-color: #e3f2fd;
      border-color: var(--primary-color);
      transform: translateX(5px);
    }

    .selected {
      background-color: #e3f2fd;
      border-color: var(--primary-color);
    }

    .correct {
      background-color: #c8e6c9;
      border-color: var(--success-color);
      animation: correctPulse 0.4s 2;
    }

    /* é¡¯ç¤ºã€ŒçœŸæ­£çš„ã€æ­£è§£ç”¨ */
    .correct-answer {
      background-color: #c8e6c9;
      border-color: var(--success-color);
      animation: correctPulse 0.4s 2;
      opacity: 0.9;
    }

    @keyframes correctPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.02); }
    }

    .incorrect {
      background-color: #ffcdd2;
      border-color: var(--error-color);
      animation: shake 0.6s;
    }

    /* éŒ¯èª¤æ™‚æ–æ™ƒ */
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      20% { transform: translateX(-6px); }
      40% { transform: translateX(6px); }
      60% { transform: translateX(-4px); }
      80% { transform: translateX(4px); }
    }

    .audio-controls {
      margin: 15px 0;
      padding: 15px;
      background-color: #e3f2fd;
      border-radius: 8px;
      display: flex;
      gap: 5px;
      align-items: center;
    }

    .play-button {
      background-color: var(--secondary-color);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.2s;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .play-button:hover {
      background-color: #45a049;
    }

    .explanation {
      margin-top: 15px;
      padding: 15px;
      background-color: #fff3e0;
      border-radius: 8px;
      display: none;
    }

    .explanation.show {
      display: block;
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    button {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: bold;
    }

    .primary-button {
      background-color: var(--primary-color);
      color: white;
    }

    .primary-button:hover {
      background-color: #1976d2;
    }

    .secondary-button {
      background-color: #e0e0e0;
      color: var(--text-color);
    }

    .secondary-button:hover {
      background-color: #bdbdbd;
    }

    .error-message, .status-message {
      margin: 10px 0;
      padding: 15px;
      border-radius: 8px;
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .error-message {
      background-color: #ffebee;
      color: var(--error-color);
    }

    .status-message {
      background-color: #e8f5e9;
      color: var(--success-color);
    }

    /* ğŸŸ¢ é€™è£¡æ˜¯ã€ŒéŒ¯èª¤ã€ç‹€æ…‹(ç­”éŒ¯äº†ï¼Œå†æ¥å†å²)æ™‚ï¼Œä½¿ç”¨ç´…è‰²é‚Šæ¡† */
    .status-message.wrong {
      background-color: #ffebee;
      color: var(--error-color);
      border: 2px solid var(--error-color);
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .timer {
      position: fixed;
      top: 20px;
      right: 20px;
      background-color: var(--primary-color);
      color: white;
      padding: 10px 20px;
      border-radius: 20px;
      font-weight: bold;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      z-index: 9999;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 1000;
    }

    .modal-content {
      position: relative;
      background-color: white;
      margin: 15% auto;
      padding: 20px;
      width: 80%;
      max-width: 500px;
      border-radius: 10px;
      animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
      from { transform: translateY(-100px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .close-button {
      position: absolute;
      right: 20px;
      top: 10px;
      font-size: 24px;
      cursor: pointer;
    }

    .passage {
      margin: 20px 0;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid var(--primary-color);
      font-size: 1.1em;
      line-height: 1.6;
    }

    .passage p {
      margin: 0;
      color: var(--text-color);
    }

    .progress-info {
      margin-top: 20px;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 8px;
      animation: fadeIn 0.6s ease;
    }

    .section-progress {
      display: flex;
      justify-content: space-around;
      margin: 10px 0;
    }

    .reset-button {
      background-color: var(--error-color);
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .reset-button:hover {
      background-color: #d32f2f;
    }

    /* æ·¡å…¥å‹•ç•« */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ğŸŸ¢ Confetti Canvasï¼šé¡¯ç¤ºåœ¨æœ€ä¸Šå±¤ä»¥é”çˆ†è£‚æ•ˆæœ */
    #confetti-canvas {
      pointer-events: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 9999;
    }

    /********************************************
     * æ‰‹æ©Ÿæ¨¡å¼æ¨£å¼ï¼šç•¶ body åŠ ä¸Š .mobile-view æ™‚ç”Ÿæ•ˆ
     ********************************************/
    body.mobile-view {
      max-width: 100%;
      padding: 10px;
    }

    body.mobile-view .container {
      border-radius: 0;
      padding: 10px;
      box-shadow: none;
    }

    body.mobile-view .header {
      border-radius: 0;
      font-size: 1em;
    }

    body.mobile-view .stats {
      flex-direction: column;
      gap: 10px;
    }

    body.mobile-view .section {
      margin: 15px 0;
      padding: 10px;
    }

    body.mobile-view .section h2 {
      font-size: 1.2em;
    }

    body.mobile-view .option {
      margin: 5px 0;
      padding: 10px;
    }

    body.mobile-view .stat-value {
      font-size: 1.2em;
    }

    body.mobile-view h1 {
      font-size: 1.8em;
    }
  </style>
</head>
<body>
  <!-- ğŸ‰ ç”¨æ–¼æ”¾ç½®äº”å½©ç´™å±‘çš„ç•«å¸ƒ -->
  <canvas id="confetti-canvas"></canvas>

  <div class="timer" id="timer">æ™‚é–“: 00:00</div>

  <div class="container">
    <div class="header">
      <h1>å¤šç›Šè€ƒè©¦ç·´ç¿’ç³»çµ± - å¢å¼·ç‰ˆ</h1>
      <div style="margin: 10px 0;">
        <button class="secondary-button" onclick="toggleInterface()">åˆ‡æ›ä»‹é¢</button>
      </div>
      <div class="progress-bar">
        <div class="progress" id="progress"></div>
      </div>
      <div class="stats">
        <div class="stat-item">
          <div class="stat-value" id="correct-count">0</div>
          <div>æ­£ç¢º</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="total-count">0</div>
          <div>ç¸½é¡Œæ•¸</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="accuracy">0%</div>
          <div>æ­£ç¢ºç‡</div>
        </div>
      </div>
      <div class="progress-info">
        <p>å·²å®Œæˆé¡Œç›®ï¼š</p>
        <div class="section-progress">
          <span>è½åŠ›ï¼š<span id="listening-progress">0</span>/<span id="listening-total">0</span></span>
          <span>é–±è®€ï¼š<span id="reading-progress">0</span>/<span id="reading-total">0</span></span>
          <span>èªæ³•ï¼š<span id="grammar-progress">0</span>/<span id="grammar-total">0</span></span>
        </div>
        <button onclick="resetProgress()" class="reset-button">é‡ç½®é€²åº¦</button>
      </div>
    </div>

    <div class="section">
      <h2>è½åŠ›ç·´ç¿’</h2>
      <div id="listening-question" class="question">
        <!-- è½åŠ›é¡Œç›®å°‡ç”± JavaScript å‹•æ…‹è¼‰å…¥ -->
      </div>
      <div id="listening-error" class="error-message"></div>
      <div id="listening-status" class="status-message"></div>
    </div>

    <div class="section">
      <h2>é–±è®€ç·´ç¿’</h2>
      <div id="reading-question" class="question">
        <!-- é–±è®€é¡Œç›®å°‡ç”± JavaScript å‹•æ…‹è¼‰å…¥ -->
      </div>
      <div id="reading-error" class="error-message"></div>
      <div id="reading-status" class="status-message"></div>
    </div>

    <div class="section">
      <h2>èªæ³•ç·´ç¿’</h2>
      <div id="grammar-question" class="question">
        <!-- èªæ³•é¡Œç›®å°‡ç”± JavaScript å‹•æ…‹è¼‰å…¥ -->
      </div>
      <div id="grammar-error" class="error-message"></div>
      <div id="grammar-status" class="status-message"></div>
    </div>
  </div>

  <!-- è©³ç´°è§£æçš„å½ˆçª— -->
  <div id="explanation-modal" class="modal">
    <div class="modal-content">
      <span class="close-button" onclick="closeExplanation()">&times;</span>
      <h3>è©³ç´°è§£æ</h3>
      <div id="explanation-content"></div>
    </div>
  </div>

  <!-- å…ˆè¼‰å…¥é¡Œåº«æª”æ¡ˆ -->
  <script src="questions.js"></script>

  <!-- ä¸‹é¢æ˜¯äº”å½©ç´™å±‘çš„ç°¡æ˜“å‡½å¼ (ä½¿ç”¨ canvas) -->
  <script>
    // ä¾†æºåƒè€ƒ: https://www.kirilv.com/canvas-confetti/
    const confettiCanvas = document.getElementById('confetti-canvas');
    const confettiCtx = confettiCanvas.getContext('2d');
    let confettiParticles = [];
    let confettiActive = false;
    let animationFrame;

    function initConfetti() {
      confettiCanvas.width = window.innerWidth;
      confettiCanvas.height = window.innerHeight;
      window.addEventListener('resize', () => {
        confettiCanvas.width = window.innerWidth;
        confettiCanvas.height = window.innerHeight;
      });
    }

    function randomRange(min, max) {
      return Math.random() * (max - min) + min;
    }

    function createConfettiParticles() {
      const colors = [
        'rgba(255,99,71,',   // tomato
        'rgba(54,162,235,',  // blue
        'rgba(255,206,86,',  // yellow
        'rgba(75,192,192,'   // green
      ];
      for (let i = 0; i < 100; i++) {
        confettiParticles.push({
          x: randomRange(0, confettiCanvas.width),
          y: randomRange(0, confettiCanvas.height - 200),
          r: randomRange(6, 12),
          color: colors[Math.floor(Math.random() * colors.length)] + (Math.random() + 0.5) + ')',
          tilt: randomRange(-10, 10),
          tiltAngleIncremental: randomRange(0.05, 0.12),
          tiltAngle: 0,
          speed: randomRange(2, 5)
        });
      }
    }

    function drawConfetti() {
      confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
      confettiParticles.forEach((p) => {
        confettiCtx.beginPath();
        confettiCtx.lineWidth = p.r;
        confettiCtx.strokeStyle = p.color;
        confettiCtx.moveTo(p.x + p.tilt + p.r / 2, p.y);
        confettiCtx.lineTo(p.x + p.tilt, p.y + p.tilt + p.r / 2);
        confettiCtx.stroke();
      });
      updateConfetti();
      animationFrame = requestAnimationFrame(drawConfetti);
    }

    function updateConfetti() {
      confettiParticles.forEach((p, i) => {
        p.tiltAngle += p.tiltAngleIncremental;
        p.y += (p.speed);
        p.x += Math.sin(p.tiltAngle);

        p.tilt = Math.sin(p.tiltAngle) * 15;

        if (p.y > confettiCanvas.height) {
          p.x = randomRange(0, confettiCanvas.width);
          p.y = -20;
        }
      });
    }

    function startConfetti() {
      if (!confettiActive) {
        confettiActive = true;
        confettiParticles = [];
        createConfettiParticles();
        drawConfetti();
        setTimeout(stopConfetti, 1500); // 1.5ç§’å¾Œåœæ­¢
      }
    }

    function stopConfetti() {
      confettiActive = false;
      cancelAnimationFrame(animationFrame);
      confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
      confettiParticles = [];
    }

    initConfetti();
  </script>

  <!-- ä¸»é‚è¼¯ç¨‹å¼ç¢¼ -->
  <script>
    /****************************************************************
     * 1) å…¨åŸŸè®Šæ•¸ï¼šé€²åº¦èˆ‡çµ±è¨ˆ
     ****************************************************************/
    let currentQuestions = {
      listening: 1,
      reading: 1,
      grammar: 1
    };

    let completedQuestions = {
      listening: [],
      reading: [],
      grammar: []
    };

    let stats = {
      correct: 0,
      total: 0
    };

    let startTime = new Date();
    let timerInterval;

    // ä»‹é¢åˆ‡æ›
    let isMobileView = false;

    /****************************************************************
     * 2) åˆ‡æ›ä»‹é¢æ¨¡å¼ï¼ˆæ¡Œé¢ / æ‰‹æ©Ÿï¼‰
     ****************************************************************/
    function toggleInterface() {
      isMobileView = !isMobileView;
      if (isMobileView) {
        document.body.classList.add('mobile-view');
      } else {
        document.body.classList.remove('mobile-view');
      }
    }

    /****************************************************************
     * 3) è¨ˆæ™‚å™¨
     ****************************************************************/
    function updateTimer() {
      const now = new Date();
      const diff = Math.floor((now - startTime) / 1000);
      const minutes = Math.floor(diff / 60);
      const seconds = diff % 60;
      document.getElementById('timer').textContent =
          `æ™‚é–“: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    /****************************************************************
     * 4) é¡¯ç¤ºçµ±è¨ˆï¼†é€²åº¦
     ****************************************************************/
    function updateStats() {
      document.getElementById('correct-count').textContent = stats.correct;
      document.getElementById('total-count').textContent = stats.total;
      const accuracy = stats.total > 0
        ? Math.round((stats.correct / stats.total) * 100)
        : 0;
      document.getElementById('accuracy').textContent = `${accuracy}%`;
    }

    function updateProgress() {
      // æ›´æ–°å„éƒ¨åˆ†çš„é€²åº¦
      document.getElementById('listening-progress').textContent = completedQuestions.listening.length;
      document.getElementById('reading-progress').textContent = completedQuestions.reading.length;
      document.getElementById('grammar-progress').textContent = completedQuestions.grammar.length;

      // æ›´æ–°ç¸½é¡Œæ•¸
      document.getElementById('listening-total').textContent = questions.listening.length;
      document.getElementById('reading-total').textContent = questions.reading.length;
      document.getElementById('grammar-total').textContent = questions.grammar.length;

      // æ›´æ–°é€²åº¦æ¢
      const totalQuestions = questions.listening.length +
                             questions.reading.length +
                             questions.grammar.length;
      const completedTotal = completedQuestions.listening.length +
                             completedQuestions.reading.length +
                             completedQuestions.grammar.length;
      const progress = (completedTotal / totalQuestions) * 100;
      document.getElementById('progress').style.width = `${progress}%`;
    }

    /****************************************************************
     * 5) æœ¬åœ°å­˜å„²
     ****************************************************************/
    function saveProgress() {
      localStorage.setItem('toeicProgress', JSON.stringify({
        completedQuestions,
        currentQuestions,
        stats
      }));
    }

    function loadProgress() {
      const savedData = localStorage.getItem('toeicProgress');
      if (savedData) {
        const data = JSON.parse(savedData);
        completedQuestions = data.completedQuestions || { listening: [], reading: [], grammar: [] };
        currentQuestions = data.currentQuestions || { listening: 1, reading: 1, grammar: 1 };
        stats = data.stats || { correct: 0, total: 0 };
      }
    }

    /****************************************************************
     * 6) è©³ç´°è§£æçš„å½ˆçª—
     ****************************************************************/
    function showExplanation(explanation) {
      if (!explanation) return;
      const modal = document.getElementById('explanation-modal');
      const content = document.getElementById('explanation-content');
      content.innerHTML = explanation;
      modal.style.display = 'block';
    }

    function closeExplanation() {
      document.getElementById('explanation-modal').style.display = 'none';
    }

    /****************************************************************
     * 7) èªéŸ³åŠŸèƒ½
     ****************************************************************/
    let speechSynth = window.speechSynthesis;
    let currentUtterance = null;

    const voicesConfig = {
      male: {
        name: 'Microsoft David - English (United States)',
        pitch: 0.9,
        rate: 0.9
      },
      female: {
        name: 'Microsoft Zira - English (United States)',
        pitch: 1.1,
        rate: 0.9
      }
    };

    function getVoice(speaker) {
      const voiceSettings = voicesConfig[speaker] || voicesConfig.male;
      const availableVoices = speechSynth.getVoices();
      let voice = availableVoices.find(v => v.name === voiceSettings.name);
      if (!voice) {
        voice = availableVoices[0];
      }
      return {
        voice: voice,
        pitch: voiceSettings.pitch,
        rate: voiceSettings.rate
      };
    }

    function speak(text, speaker = 'male') {
      try {
        if (currentUtterance) {
          speechSynth.cancel();
        }
        const voiceSettings = getVoice(speaker);
        currentUtterance = new SpeechSynthesisUtterance(text);
        currentUtterance.voice = voiceSettings.voice;
        currentUtterance.lang = 'en-US';
        currentUtterance.rate = voiceSettings.rate;
        currentUtterance.pitch = voiceSettings.pitch;
        currentUtterance.onerror = function() {
          showError('listening', 'èªéŸ³æ’­æ”¾å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨è¨­å®šæˆ–é‡æ–°æ•´ç†é é¢');
        };
        speechSynth.speak(currentUtterance);
        showStatus('listening', 'æ­£åœ¨æ’­æ”¾éŸ³è¨Š...');
      } catch (error) {
        showError('listening', 'æ‚¨çš„ç€è¦½å™¨å¯èƒ½ä¸æ”¯æ´èªéŸ³åŠŸèƒ½ï¼Œè«‹ä½¿ç”¨æœ€æ–°ç‰ˆçš„ Chrome æˆ– Edgeã€‚');
      }
    }

    /****************************************************************
     * 8) æç¤ºè¨Šæ¯é¡¯ç¤º
     ****************************************************************/
    function showError(section, message) {
      const errorDiv = document.getElementById(`${section}-error`);
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      setTimeout(() => {
        errorDiv.style.display = 'none';
      }, 3000);
    }

    /**
     * é¡¯ç¤ºç‹€æ…‹è¨Šæ¯ï¼Œå¯å‚³å…¥ type='wrong' ä¾†é¡¯ç¤ºç´…è‰²æ¡†
     * @param {string} section - listening, reading, grammar
     * @param {string} message - é¡¯ç¤ºçš„æ–‡å­—
     * @param {string} type - å¯é¸: 'wrong'
     */
    function showStatus(section, message, type) {
      const statusDiv = document.getElementById(`${section}-status`);
      statusDiv.textContent = message;
      statusDiv.className = 'status-message'; // å…ˆé‡ç½®
      if (type === 'wrong') {
        statusDiv.classList.add('wrong'); // åŠ ä¸Šç´…è‰²æ¡†
      }
      statusDiv.style.display = 'block';
      setTimeout(() => {
        statusDiv.style.display = 'none';
      }, 3000);
    }

    /****************************************************************
     * 9) é¡Œç›®é¡¯ç¤º & ä½œç­”é‚è¼¯
     ****************************************************************/
    function findQuestion(section, questionId) {
      return questions[section].find(q => q.id === questionId);
    }

    function isCompleted(section, id) {
      return completedQuestions[section].includes(id);
    }

    function getNextQuestionId(section) {
      const allIds = questions[section].map(q => q.id);
      for (let id of allIds) {
        if (!isCompleted(section, id)) {
          return id;
        }
      }
      return null;
    }

    function displayQuestion(section) {
      const nextId = getNextQuestionId(section);
      if (nextId === null) {
        document.getElementById(`${section}-question`).innerHTML =
          '<p>æ­¤éƒ¨åˆ†æ‰€æœ‰é¡Œç›®å·²å®Œæˆï¼è«‹é‡ç½®é€²åº¦æˆ–ç­‰å¾…æ–°é¡Œç›®æ›´æ–°ã€‚</p>';
        return;
      }

      currentQuestions[section] = nextId;
      const question = findQuestion(section, nextId);
      if (!question) {
        showError(section, 'ç„¡æ³•è¼‰å…¥é¡Œç›®ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
        return;
      }

      let html = `<p>Question ${question.id}: ${question.question}</p>`;

      // è½åŠ›é¡Œç›®
      if (section === 'listening' && question.audioText) {
        html += `
          <div class="audio-controls">
            <button class="play-button"
              onclick="speak('${question.audioText.replace(/'/g, "\\'")}', '${question.speaker}')">
              æ’­æ”¾éŸ³è¨Š
            </button>
          </div>
        `;
      }
      // é–±è®€é¡Œç›®
      else if (section === 'reading' && question.passage) {
        html += `
          <div class="passage">
            <p>${question.passage}</p>
          </div>
        `;
      }

      // é¸é …
      question.options.forEach((option, index) => {
        html += `
          <div class="option" onclick="selectAnswer('${section}', ${index})">
            ${String.fromCharCode(65 + index)}) ${option}
          </div>
        `;
      });

      html += `<button onclick="submitAnswer('${section}')">æäº¤ç­”æ¡ˆ</button>`;
      document.getElementById(`${section}-question`).innerHTML = html;
      saveProgress();
    }

    function selectAnswer(section, answerIndex) {
      const container = document.getElementById(`${section}-question`);
      const options = container.getElementsByClassName('option');
      for (let option of options) {
        option.classList.remove('selected');
      }
      options[answerIndex].classList.add('selected');
    }

    function submitAnswer(section) {
      const container = document.getElementById(`${section}-question`);
      const options = container.getElementsByClassName('option');
      const selectedOption = container.querySelector('.selected');
      if (!selectedOption) {
        showError(section, 'è«‹é¸æ“‡ä¸€å€‹ç­”æ¡ˆï¼');
        return;
      }

      const selectedIndex = Array.from(options).indexOf(selectedOption);
      const questionId = currentQuestions[section];
      const question = findQuestion(section, questionId);
      if (!question) {
        showError(section, 'æ‰¾ä¸åˆ°é¡Œç›®ï¼');
        return;
      }

      const isCorrect = (selectedIndex === question.correctAnswer);

      // æ›´æ–°çµ±è¨ˆ
      stats.total++;
      if (isCorrect) {
        stats.correct++;
        // ç­”å°æ™‚è§¸ç™¼äº”å½©ç´™å±‘
        startConfetti();
        showStatus(section, 'ç­”å°äº†ï¼Œæ­å–œï¼');
        selectedOption.classList.remove('selected');
        selectedOption.classList.add('correct');
      } else {
        // ğŸŸ¢ ç”¨ç´…è‰²æ¡†æç¤ºã€Œç­”éŒ¯äº†ï¼Œå†æ¥å†å²ã€
        showStatus(section, 'ç­”éŒ¯äº†ï¼Œå†æ¥å†å²ï¼', 'wrong');
        selectedOption.classList.remove('selected');
        selectedOption.classList.add('incorrect');

        // é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆ
        const correctOption = options[question.correctAnswer];
        correctOption.classList.add('correct-answer');
      }

      // è¨˜éŒ„å®Œæˆ
      if (!completedQuestions[section].includes(questionId)) {
        completedQuestions[section].push(questionId);
      }

      updateStats();
      updateProgress();
      saveProgress();

      // é¡¯ç¤ºè§£æï¼ˆè‹¥æœ‰ï¼‰
      if (question.explanation) {
        showExplanation(question.explanation);
      }

      // 2 ç§’å¾Œè¼‰å…¥ä¸‹ä¸€é¡Œ
      setTimeout(() => {
        // ç§»é™¤å‰ä¸€é¡Œæ¨£å¼
        for (let opt of options) {
          opt.classList.remove('correct');
          opt.classList.remove('incorrect');
          opt.classList.remove('correct-answer');
        }
        displayQuestion(section);
      }, 2000);
    }

    /****************************************************************
     * 10) é‡ç½®æ‰€æœ‰é€²åº¦ + æ¸…é™¤ç¶²ç«™å¿«å–
     ****************************************************************/
    function resetProgress() {
      if (confirm('ç¢ºå®šè¦é‡ç½®æ‰€æœ‰é€²åº¦å—ï¼Ÿ(åŒæ™‚å°‡åˆªé™¤ç¶²ç«™å¿«å–) æ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
        try {
          completedQuestions = {
            listening: [],
            reading: [],
            grammar: []
          };
          currentQuestions = {
            listening: 1,
            reading: 1,
            grammar: 1
          };
          stats = {
            correct: 0,
            total: 0
          };
          localStorage.removeItem('toeicProgress');
          localStorage.clear();

          // åˆªé™¤æ‰€æœ‰ Service Worker Cache
          if ('caches' in window) {
            caches.keys().then((cacheNames) => {
              cacheNames.forEach((cacheName) => {
                caches.delete(cacheName);
              });
            });
          }

          alert('é€²åº¦å·²æˆåŠŸé‡ç½®ï¼Œä¸¦å·²åˆªé™¤å¿«å–ã€‚é é¢å°‡é‡æ–°è¼‰å…¥ï¼');
          window.location.reload();
        } catch (err) {
          console.error('é‡ç½®å¤±æ•—:', err);
          alert('é‡ç½®é€²åº¦æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹å˜—è©¦é‡æ–°æ•´ç†é é¢å¾Œå†è©¦ã€‚');
        }
      }
    }

    /****************************************************************
     * 11) åˆå§‹åŒ–
     ****************************************************************/
    function initialize() {
      loadProgress();
      updateProgress();
      updateStats();

      startTime = new Date();
      timerInterval = setInterval(updateTimer, 1000);

      // ç­‰å¾…è²éŸ³åˆ—è¡¨è¼‰å…¥ï¼Œä¹‹å¾Œä¾åºé¡¯ç¤ºè½åŠ›ã€é–±è®€ã€èªæ³•é¡Œ
      speechSynthesis.onvoiceschanged = function() {
        ['listening', 'reading', 'grammar'].forEach(section => displayQuestion(section));
      };
      // æœ‰äº›ç€è¦½å™¨ç›´æ¥å°±æœ‰ voices
      if (speechSynthesis.getVoices().length > 0) {
        ['listening', 'reading', 'grammar'].forEach(section => displayQuestion(section));
      }
    }

    window.onload = initialize;
  </script>
</body>
</html>
